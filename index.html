<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YesToNails Booking</title>
</head>
<body>
  <h1>Yes to Nails</h1>

  <!-- Admin Login Section -->
  <section id="adminLoginSection">
    <form id="adminLogin" onsubmit="adminAuth(event)">
      <input type="text" id="adminUser" placeholder="Username" required />
      <input type="password" id="adminPass" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <div id="adminLoginMessage"></div>
  </section>

  <!-- Admin Panel Wrapper -->
  <section id="adminPanelWrapper" style="display: none;">
    <div id="adminPanel">
      <button onclick="showServiceManager()">Manage Services</button>
      <button onclick="showBookingManager()">Manage Bookings</button>
      <button onclick="showBusinessSettings()">Business Settings</button>
      <button onclick="logoutAdmin()">Logout</button>

      <!-- Panels -->
      <div id="serviceManager" class="hidden"></div>
      <div id="bookingManager" class="hidden"></div>
      <div id="businessSettings" class="hidden">
        <form onsubmit="saveBusinessHours(event)">
          <input type="text" id="appointmentInterval" placeholder="Interval" required />
          <button type="submit">Save</button>
        </form>
        <div id="hoursMessage"></div>

        <form onsubmit="saveEmailSettings(event)">
          <input type="checkbox" id="customerEmailToggle" /> Customer Email<br />
          <input type="checkbox" id="adminEmailToggle" /> Admin Email<br />
          <input type="email" id="adminEmail" placeholder="Admin Email" required />
          <button type="submit">Save</button>
        </form>
        <div id="emailSettingsMessage"></div>
      </div>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabase = supabase.createClient(
      'https://fyphrauehrmotfderfey.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5cGhyYXVlaHJtb3RmZGVyZmV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyNzcyMjIsImV4cCI6MjA2Mzg1MzIyMn0.OwrKxqDPYPcBl6D4tsfXlKNIcUlwdmCBb1CaAVUy-K0'
    );

    let businessHours = {};
    let emailSettings = {};

    async function adminAuth(event) {
      event.preventDefault();
      const username = document.getElementById('adminUser').value;
      const password = document.getElementById('adminPass').value;

      const { data, error } = await supabase
        .from('admins')
        .select('*')
        .eq('username', username)
        .eq('password', password)
        .single();

      if (data) {
        document.getElementById('adminLoginSection').style.display = 'none';
        document.getElementById('adminPanelWrapper').style.display = 'block';
        showAdminDashboard();
        loadBusinessSettings();
        loadEmailSettings();
      } else {
        document.getElementById('adminLoginMessage').innerHTML = `<div class="error-box">Invalid username or password.</div>`;
      }
    }

    function logoutAdmin() {
      document.getElementById('adminLoginSection').style.display = 'block';
      document.getElementById('adminPanelWrapper').style.display = 'none';
      document.getElementById('adminLogin').reset();
      document.getElementById('adminLoginMessage').innerHTML = '';
    }

    function showAdminDashboard() {
      document.getElementById('serviceManager').classList.add('hidden');
      document.getElementById('bookingManager').classList.add('hidden');
      document.getElementById('businessSettings').classList.add('hidden');
    }

    function showServiceManager() {
      document.getElementById('serviceManager').classList.remove('hidden');
      document.getElementById('bookingManager').classList.add('hidden');
      document.getElementById('businessSettings').classList.add('hidden');
    }

    function showBookingManager() {
      document.getElementById('serviceManager').classList.add('hidden');
      document.getElementById('bookingManager').classList.remove('hidden');
      document.getElementById('businessSettings').classList.add('hidden');
    }

    function showBusinessSettings() {
      document.getElementById('serviceManager').classList.add('hidden');
      document.getElementById('bookingManager').classList.add('hidden');
      document.getElementById('businessSettings').classList.remove('hidden');
      loadBusinessSettings();
      loadEmailSettings();
    }

    async function loadBusinessSettings() {
      const { data, error } = await supabase.from('business_settings').select('*').single();
      if (data) {
        businessHours = JSON.parse(data.hours_json);
        document.getElementById('appointmentInterval').value = businessHours.interval || '';
      }
    }

    async function loadEmailSettings() {
      const { data, error } = await supabase.from('email_settings').select('*').single();
      if (data) {
        emailSettings = data;
        document.getElementById('customerEmailToggle').checked = data.send_to_customers;
        document.getElementById('adminEmailToggle').checked = data.send_to_admin;
        document.getElementById('adminEmail').value = data.admin_email;
      }
    }

    async function saveBusinessHours(event) {
      event.preventDefault();
      businessHours.interval = document.getElementById('appointmentInterval').value;

      const { error } = await supabase.from('business_settings').upsert({
        id: 1,
        hours_json: JSON.stringify(businessHours)
      });

      if (!error) {
        document.getElementById('hoursMessage').innerHTML = '<div class="success-message">Saved!</div>';
        setTimeout(() => document.getElementById('hoursMessage').innerHTML = '', 3000);
      }
    }

    async function saveEmailSettings(event) {
      event.preventDefault();
      emailSettings.send_to_customers = document.getElementById('customerEmailToggle').checked;
      emailSettings.send_to_admin = document.getElementById('adminEmailToggle').checked;
      emailSettings.admin_email = document.getElementById('adminEmail').value;

      const { error } = await supabase.from('email_settings').upsert({
        id: 1,
        ...emailSettings
      });

      if (!error) {
        document.getElementById('emailSettingsMessage').innerHTML = '<div class="success-message">Saved!</div>';
        setTimeout(() => document.getElementById('emailSettingsMessage').innerHTML = '', 3000);
      }
    }
  </script>
</body>
</html>
