<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Yes to Nails - Service Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <!-- Supabase -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabaseUrl = 'https://fyphrauehrmotfderfey.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5cGhyYXVlaHJtb3RmZGVyZmV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyNzcyMjIsImV4cCI6MjA2Mzg1MzIyMn0.OwrKxqDPYPcBl6D4tsfXlKNIcUlwdmCBb1CaAVUy-K0';
    window.supabase = createClient(supabaseUrl, supabaseKey);
  </script>

  <style>
    /* ✅ PASTE YOUR COMPLETE STYLE CSS HERE AS IS — already OK */
  </style>
</head>

<body>
  <div id="logoContainer"></div>
  <div id="services"></div>
  <form id="bookingForm"></form>

  <script type="module">
    // ✅ Declare shared variables
    let bookings = [];
    let cart = [];
    const businessHours = { days: {} };
    const emailSettings = {};

    // ✅ Supabase already initialized above in head

    // ========== SERVICES ==========
    async function fetchServices() {
      const { data, error } = await supabase.from('services').select('*');
      if (error) console.error('Error fetching services:', error.message);
      else renderServices(data || []);
    }

    function renderServices(services) {
      const container = document.getElementById('services');
      container.innerHTML = '';
      services.forEach(service => {
        const div = document.createElement('div');
        div.className = 'service-item';
        div.innerHTML = `
          <div class="service-info">
            <p class="service-title">${service.name}</p>
            <p class="service-category">${service.category}</p>
            <p class="service-description">${service.description}</p>
          </div>
          <div class="service-meta">
            <p>${service.duration} min</p>
            <p>AED ${service.price.toFixed(2)}</p>
            <button class="add-btn" onclick='addToCart(${JSON.stringify(service)})'>Add</button>
          </div>`;
        container.appendChild(div);
      });
    }

    // ========== BOOKINGS ==========
    async function fetchBookings() {
      const { data, error } = await supabase.from('bookings').select('*');
      if (error) console.error('Error fetching bookings:', error.message);
      bookings = data || [];
      populateBookingsList(); // You can implement this if needed
    }

    async function createBooking(newBooking) {
      const { error } = await supabase.from('bookings').insert([newBooking]);
      if (error) {
        alert('Booking failed.');
        console.error(error);
      } else {
        alert('Booking confirmed!');
        document.getElementById('bookingForm').reset();
        cart = [];
        updateCart();
        fetchBookings();
      }
    }

    // Placeholder to avoid error if not implemented yet
    function populateBookingsList() {
      console.log('populateBookingsList() not yet implemented');
    }

    // ========== BUSINESS HOURS ==========
    async function fetchBusinessHours() {
      const { data, error } = await supabase.from('business_hours').select('*');
      if (error) return console.error('Error fetching hours:', error.message);
      const daysMap = {};
      data.forEach(day => daysMap[day.day.toLowerCase()] = day);
      businessHours.days = daysMap;
    }

    async function saveBusinessHours(event) {
      event.preventDefault();
      const days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
      for (const day of days) {
        const open = document.getElementById(`${day}Open`).value;
        const close = document.getElementById(`${day}Close`).value;
        const closed = document.getElementById(`${day}Closed`).checked;
        await supabase.from('business_hours').upsert({ day, open, close, closed }, { onConflict: ['day'] });
      }
      document.getElementById('hoursMessage').innerText = 'Hours saved!';
    }

    // ========== SETTINGS (Email + Logo) ==========
    async function fetchSettings() {
      const { data, error } = await supabase.from('settings').select('*');
      if (error) return console.error('Settings fetch error:', error.message);
      data.forEach(setting => {
        if (setting.key === 'admin_email') document.getElementById('adminEmail').value = setting.value;
        if (setting.key === 'send_to_admin') document.getElementById('adminEmailToggle').checked = setting.value === 'true';
        if (setting.key === 'send_to_customer') document.getElementById('customerEmailToggle').checked = setting.value === 'true';
        if (setting.key === 'logo_url') {
          document.getElementById('logoContainer').innerHTML = `<img src="${setting.value}" alt="Logo" style="max-height:60px;">`;
        }
      });
    }

    async function saveEmailSettings() {
      const updates = [
        { key: 'admin_email', value: document.getElementById('adminEmail').value },
        { key: 'send_to_admin', value: document.getElementById('adminEmailToggle').checked.toString() },
        { key: 'send_to_customer', value: document.getElementById('customerEmailToggle').checked.toString() },
      ];
      for (const setting of updates) await supabase.from('settings').upsert(setting, { onConflict: ['key'] });
      document.getElementById('emailSettingsMessage').innerText = 'Saved!';
    }

    async function saveLogo() {
      const file = document.getElementById('logoUpload').files[0];
      if (!file) return;
      const fileName = `logo.${file.name.split('.').pop()}`;
      const { error: uploadError } = await supabase.storage.from('assets').upload(fileName, file, { upsert: true });
      if (uploadError) return console.error(uploadError.message);

      const { data } = supabase.storage.from('assets').getPublicUrl(fileName);
      const logoUrl = data.publicUrl;
      await supabase.from('settings').upsert({ key: 'logo_url', value: logoUrl });
      document.getElementById('logoPreview').innerHTML = `<img src="${logoUrl}" style="max-width:200px;">`;
    }

    // ========== PAGE LOAD ==========
    document.addEventListener('DOMContentLoaded', () => {
      fetchServices();
      fetchBookings();
      fetchBusinessHours();
      fetchSettings();
    });
  </script>
</body>
</html>
