<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Yes to Nails - Service Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <header>
  <h1 class="shimmer-text">Yes to Nails<sup>&reg;</sup></h1>
</header>

<section id="userPanel">
  <div id="logoContainer" class="centered"></div>
  <div id="services" class="service-list-card"></div>
  <div id="cartSection" class="service-list-card">
    <h2>Cart</h2>
    <ul id="cartItems"></ul>
    <p><strong>Total:</strong> AED <span id="cartTotal">0.00</span></p>
    <button class="btn" onclick="clearCart()">Clear</button>
  </div>

  <form id="bookingForm" class="service-list-card">
    <h2>Book Appointment</h2>
    <input type="text" id="name" placeholder="Your Name" required />
    <input type="email" id="email" placeholder="Your Email" required />
    <input type="tel" id="phone" placeholder="Phone Number" required />
    <input type="date" id="bookingDate" required />
    <div id="timeSlots"></div>
    <textarea id="notes" placeholder="Notes (optional)"></textarea>
    <button type="submit" class="btn">Confirm Booking</button>
  </form>
</section>

<section id="adminLoginSection" class="service-list-card">
  <h2>Admin Login</h2>
  <form id="adminLogin">
    <input type="password" id="adminPassword" placeholder="Enter Admin Password" required />
    <button type="submit" class="btn">Login</button>
  </form>
  <p id="adminLoginMessage" class="error"></p>
</section>

<section id="adminPanel" class="hidden">
  <div class="tab-buttons">
    <button onclick="showServiceManager()">Services</button>
    <button onclick="showBookingManager()">Bookings</button>
    <button onclick="showBusinessSettings()">Settings</button>
    <button onclick="logoutAdmin()" class="logout-btn">Logout</button>
  </div>

  <div id="serviceManager" class="tab-section">
    <h2>Manage Services</h2>
    <form id="addServiceForm">
      <input type="text" id="serviceName" placeholder="Name" required />
      <input type="text" id="serviceCategory" placeholder="Category" />
      <input type="number" id="servicePrice" placeholder="Price (AED)" required />
      <input type="number" id="serviceDuration" placeholder="Duration (min)" required />
      <textarea id="serviceDescription" placeholder="Description"></textarea>
      <button type="submit" class="btn">Add Service</button>
    </form>
    <div id="serviceList"></div>
  </div>

  <div id="bookingManager" class="tab-section hidden">
    <h2>Manage Bookings</h2>
    <table>
      <thead>
        <tr>
          <th>Date & Time</th>
          <th>Client</th>
          <th>Services</th>
          <th>Price & Duration</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="bookingsList"></tbody>
    </table>
  </div>

  <div id="businessSettings" class="tab-section hidden">
    <h2>Business Hours</h2>
    <form id="businessHoursForm">
      <div id="businessHoursFields"></div>
      <button type="submit" class="btn">Save Hours</button>
      <p id="hoursMessage" class="success"></p>
    </form>

    <h2>Logo</h2>
    <input type="file" id="logoUpload" />
    <button class="btn" onclick="saveLogo()">Save Logo</button>
    <div id="logoPreview"></div>

    <h2>Email Settings</h2>
    <label>Email for Admin Notifications</label>
    <input type="email" id="adminEmail" />
    <label><input type="checkbox" id="adminEmailToggle" /> Send Email to Admin</label><br />
    <label><input type="checkbox" id="customerEmailToggle" /> Send Email to Customer</label><br />
    <button class="btn" onclick="saveEmailSettings()">Save Email Settings</button>
    <p id="emailSettingsMessage" class="success"></p>
  </div>
</section>


  <!-- Supabase -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabaseUrl = 'https://fyphrauehrmotfderfey.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5cGhyYXVlaHJtb3RmZGVyZmV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyNzcyMjIsImV4cCI6MjA2Mzg1MzIyMn0.OwrKxqDPYPcBl6D4tsfXlKNIcUlwdmCBb1CaAVUy-K0';
    window.supabase = createClient(supabaseUrl, supabaseKey);
  </script>

  <style>
    /* ✅ PASTE YOUR COMPLETE STYLE CSS HERE AS IS — already OK */
  </style>
</head>

<body>
<header>
  <div id="logoContainer">
    <!-- Logo from Supabase setting -->
  </div>
  <h1 class="shimmer-text">Yes to Nails<sup>&reg;</sup></h1>
</header>

<nav>
  <a onclick="showUserPanel()">Book</a>
  <a onclick="showAdminLogin()">Admin</a>
</nav>
<main id="userPanel">
  <section id="services" class="service-list-card">
    <!-- Services from Supabase will populate here -->
  </section>

  <section id="cartSection">
    <h2>Your Cart</h2>
    <div id="cartItems"></div>
    <div class="total-section">
      <div class="total-row"><span>Total:</span><span id="totalPrice">AED 0.00</span></div>
      <div class="total-row"><span>Total Duration:</span><span id="totalDuration">0 mins</span></div>
    </div>
  </section>

  <section>
    <h2>Book Appointment</h2>
    <form id="bookingForm" onsubmit="submitBooking(event)">
      <input type="text" id="name" placeholder="Your Name" required>
      <input type="email" id="email" placeholder="Your Email" required>
      <input type="tel" id="phone" placeholder="Your Phone" required>
      <input type="date" id="bookingDate" required onchange="showTimeSlots()">

      <div id="timeSlotContainer" class="time-slots-container"></div>

      <textarea id="notes" placeholder="Notes (optional)"></textarea>
      <button class="btn" type="submit">Confirm Booking</button>
    </form>
  </section>
</main>


  <script type="module">
    // ✅ Declare shared variables
    let bookings = [];
    let cart = [];
    const businessHours = { days: {} };
    const emailSettings = {};

    // ✅ Supabase already initialized above in head

    // ========== SERVICES ==========
    async function fetchServices() {
      const { data, error } = await supabase.from('services').select('*');
      if (error) console.error('Error fetching services:', error.message);
      else renderServices(data || []);
    }

    function renderServices(services) {
      const container = document.getElementById('services');
      container.innerHTML = '';
      services.forEach(service => {
        const div = document.createElement('div');
        div.className = 'service-item';
        div.innerHTML = `
          <div class="service-info">
            <p class="service-title">${service.name}</p>
            <p class="service-category">${service.category}</p>
            <p class="service-description">${service.description}</p>
          </div>
          <div class="service-meta">
            <p>${service.duration} min</p>
            <p>AED ${service.price.toFixed(2)}</p>
            <button class="add-btn" onclick='addToCart(${JSON.stringify(service)})'>Add</button>
          </div>`;
        container.appendChild(div);
      });
    }


    // ========== BOOKINGS ==========
    async function fetchBookings() {
      const { data, error } = await supabase.from('bookings').select('*');
      if (error) console.error('Error fetching bookings:', error.message);
      bookings = data || [];
      populateBookingsList(); // You can implement this if needed
    }

    async function createBooking(newBooking) {
      const { error } = await supabase.from('bookings').insert([newBooking]);
      if (error) {
        alert('Booking failed.');
        console.error(error);
      } else {
        alert('Booking confirmed!');
        document.getElementById('bookingForm').reset();
        cart = [];
        updateCart();
        fetchBookings();
      }
    }

    // Placeholder to avoid error if not implemented yet
    function populateBookingsList() {
      console.log('populateBookingsList() not yet implemented');
    }

    // ========== BUSINESS HOURS ==========
    async function fetchBusinessHours() {
      const { data, error } = await supabase.from('business_hours').select('*');
      if (error) return console.error('Error fetching hours:', error.message);
      const daysMap = {};
      data.forEach(day => daysMap[day.day.toLowerCase()] = day);
      businessHours.days = daysMap;
    }

    async function saveBusinessHours(event) {
      event.preventDefault();
      const days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
      for (const day of days) {
        const open = document.getElementById(`${day}Open`).value;
        const close = document.getElementById(`${day}Close`).value;
        const closed = document.getElementById(`${day}Closed`).checked;
        await supabase.from('business_hours').upsert({ day, open, close, closed }, { onConflict: ['day'] });
      }
      document.getElementById('hoursMessage').innerText = 'Hours saved!';
    }

    // ========== SETTINGS (Email + Logo) ==========
    async function fetchSettings() {
      const { data, error } = await supabase.from('settings').select('*');
      if (error) return console.error('Settings fetch error:', error.message);
      data.forEach(setting => {
        if (setting.key === 'admin_email') document.getElementById('adminEmail').value = setting.value;
        if (setting.key === 'send_to_admin') document.getElementById('adminEmailToggle').checked = setting.value === 'true';
        if (setting.key === 'send_to_customer') document.getElementById('customerEmailToggle').checked = setting.value === 'true';
        if (setting.key === 'logo_url') {
          document.getElementById('logoContainer').innerHTML = `<img src="${setting.value}" alt="Logo" style="max-height:60px;">`;
        }
      });
    }

    async function saveEmailSettings() {
      const updates = [
        { key: 'admin_email', value: document.getElementById('adminEmail').value },
        { key: 'send_to_admin', value: document.getElementById('adminEmailToggle').checked.toString() },
        { key: 'send_to_customer', value: document.getElementById('customerEmailToggle').checked.toString() },
      ];
      for (const setting of updates) await supabase.from('settings').upsert(setting, { onConflict: ['key'] });
      document.getElementById('emailSettingsMessage').innerText = 'Saved!';
    }

    async function saveLogo() {
      const file = document.getElementById('logoUpload').files[0];
      if (!file) return;
      const fileName = `logo.${file.name.split('.').pop()}`;
      const { error: uploadError } = await supabase.storage.from('assets').upload(fileName, file, { upsert: true });
      if (uploadError) return console.error(uploadError.message);

      const { data } = supabase.storage.from('assets').getPublicUrl(fileName);
      const logoUrl = data.publicUrl;
      await supabase.from('settings').upsert({ key: 'logo_url', value: logoUrl });
      document.getElementById('logoPreview').innerHTML = `<img src="${logoUrl}" style="max-width:200px;">`;
    }

    // ========== PAGE LOAD ==========
    document.addEventListener('DOMContentLoaded', () => {
      fetchServices();
      fetchBookings();
      fetchBusinessHours();
      fetchSettings();
    });
  </script>
  <footer>
  &copy; 2025 Yes to Nails. All rights reserved.
</footer>

<div id="adminLoginSection" class="hidden">
  <!-- Add your Admin login form here if needed -->
</div>

<div id="adminPanel" class="hidden">
  <!-- Add your Admin dashboard tabs and forms here -->
</div>

</body>
</html>
